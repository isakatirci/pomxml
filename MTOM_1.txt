
M√ºkemmel! ≈ûimdi anlƒ±yorum. Bu bir **MTOM (Message Transmission Optimization Mechanism)** formatƒ±nda SOAP mesajƒ±. ƒ∞ki b√∂l√ºmden olu≈üuyor:

1. **ƒ∞lk b√∂l√ºm**: SOAP envelope (XML)
2. **ƒ∞kinci b√∂l√ºm**: Binary attachment (camt.053 ISO20022 belgesi)

Size **MTOM destekli** profesyonel bir SOAP mock server projesi hazƒ±rlayacaƒüƒ±m.

## üéØ MTOM Destekli SOAP Mock Server

### **1. pom.xml**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.2.0</version>
        <relativePath/>
    </parent>

    <groupId>com.example</groupId>
    <artifactId>soap-mock-server-mtom</artifactId>
    <version>1.0.0</version>
    <name>SOAP Mock Server with MTOM</name>
    <description>SOAP Mock Server with Binary Attachment Support (MTOM)</description>

    <properties>
        <java.version>17</java.version>
    </properties>

    <dependencies>
        <!-- Spring Boot Web Services -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web-services</artifactId>
        </dependency>

        <!-- WSDL Support -->
        <dependency>
            <groupId>wsdl4j</groupId>
            <artifactId>wsdl4j</artifactId>
        </dependency>

        <!-- SAAJ Implementation for MTOM -->
        <dependency>
            <groupId>com.sun.xml.messaging.saaj</groupId>
            <artifactId>saaj-impl</artifactId>
        </dependency>

        <!-- Lombok -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>

        <!-- Spring Boot Actuator -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>

        <!-- Test Dependencies -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>org.springframework.ws</groupId>
            <artifactId>spring-ws-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

### **2. Application.java**

```java
package com.example.soapmock;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

/**
 * SOAP Mock Server with MTOM Support
 * Returns SOAP messages with binary attachments
 */
@SpringBootApplication
public class SoapMockServerApplication {

    public static void main(String[] args) {
        SpringApplication.run(SoapMockServerApplication.class, args);
    }
}
```

### **3. WebServiceConfig.java**

```java
package com.example.soapmock.config;

import jakarta.xml.soap.MessageFactory;
import jakarta.xml.soap.SOAPConstants;
import jakarta.xml.soap.SOAPException;
import org.springframework.boot.web.servlet.ServletRegistrationBean;
import org.springframework.context.ApplicationContext;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.io.ClassPathResource;
import org.springframework.ws.config.annotation.EnableWs;
import org.springframework.ws.config.annotation.WsConfigurerAdapter;
import org.springframework.ws.server.EndpointInterceptor;
import org.springframework.ws.soap.saaj.SaajSoapMessageFactory;
import org.springframework.ws.transport.http.MessageDispatcherServlet;
import org.springframework.ws.wsdl.wsdl11.SimpleWsdl11Definition;
import org.springframework.ws.wsdl.wsdl11.Wsdl11Definition;

import java.util.List;

/**
 * Web Service Configuration with MTOM Support
 */
@EnableWs
@Configuration
public class WebServiceConfig extends WsConfigurerAdapter {

    private final SoapLoggingInterceptor loggingInterceptor;

    public WebServiceConfig(SoapLoggingInterceptor loggingInterceptor) {
        this.loggingInterceptor = loggingInterceptor;
    }

    /**
     * MTOM-enabled SOAP Message Factory
     */
    @Bean
    public SaajSoapMessageFactory messageFactory() throws SOAPException {
        MessageFactory messageFactory = MessageFactory.newInstance(SOAPConstants.SOAP_1_1_PROTOCOL);
        SaajSoapMessageFactory saajSoapMessageFactory = new SaajSoapMessageFactory(messageFactory);
        saajSoapMessageFactory.setMtomEnabled(true);
        return saajSoapMessageFactory;
    }

    /**
     * Message Dispatcher Servlet
     */
    @Bean
    public ServletRegistrationBean<MessageDispatcherServlet> messageDispatcherServlet(
            ApplicationContext applicationContext) {
        MessageDispatcherServlet servlet = new MessageDispatcherServlet();
        servlet.setApplicationContext(applicationContext);
        servlet.setTransformWsdlLocations(true);
        return new ServletRegistrationBean<>(servlet, "/ws/*");
    }

    /**
     * WSDL Definition
     */
    @Bean(name = "soapha")
    public Wsdl11Definition defaultWsdl11Definition() {
        SimpleWsdl11Definition wsdl11Definition = new SimpleWsdl11Definition();
        wsdl11Definition.setWsdl(new ClassPathResource("wsdl/soapha.wsdl"));
        return wsdl11Definition;
    }

    /**
     * Add interceptors
     */
    @Override
    public void addInterceptors(List<EndpointInterceptor> interceptors) {
        interceptors.add(loggingInterceptor);
    }
}
```

### **4. SoapLoggingInterceptor.java**

```java
package com.example.soapmock.config;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import org.springframework.ws.context.MessageContext;
import org.springframework.ws.server.EndpointInterceptor;
import org.springframework.ws.soap.saaj.SaajSoapMessage;

import java.io.ByteArrayOutputStream;

/**
 * SOAP Message Logging Interceptor
 */
@Slf4j
@Component
public class SoapLoggingInterceptor implements EndpointInterceptor {

    @Override
    public boolean handleRequest(MessageContext messageContext, Object endpoint) {
        logSoapMessage("Incoming SOAP Request", messageContext);
        return true;
    }

    @Override
    public boolean handleResponse(MessageContext messageContext, Object endpoint) {
        logSoapMessage("Outgoing SOAP Response", messageContext);
        return true;
    }

    @Override
    public boolean handleFault(MessageContext messageContext, Object endpoint) {
        log.error("SOAP Fault occurred");
        logSoapMessage("SOAP Fault", messageContext);
        return true;
    }

    @Override
    public void afterCompletion(MessageContext messageContext, Object endpoint, Exception ex) {
        if (ex != null) {
            log.error("Error processing SOAP message", ex);
        }
    }

    private void logSoapMessage(String prefix, MessageContext messageContext) {
        try {
            SaajSoapMessage message = (SaajSoapMessage) messageContext.getRequest();
            ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
            message.writeTo(outputStream);
            String payload = outputStream.toString();
            log.debug("{}: \n{}", prefix, payload);
            log.info("{} - Content-Type: {}", prefix, message.getSaajMessage().getMimeHeaders().getHeader("Content-Type"));
        } catch (Exception e) {
            log.warn("Could not log SOAP message: {}", e.getMessage());
        }
    }
}
```

### **5. MockSoapEndpoint.java**

```java
package com.example.soapmock.endpoint;

import com.example.soapmock.service.MockResponseService;
import jakarta.activation.DataHandler;
import jakarta.xml.soap.AttachmentPart;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ws.context.MessageContext;
import org.springframework.ws.server.endpoint.annotation.Endpoint;
import org.springframework.ws.server.endpoint.annotation.PayloadRoot;
import org.springframework.ws.server.endpoint.annotation.RequestPayload;
import org.springframework.ws.server.endpoint.annotation.ResponsePayload;
import org.springframework.ws.soap.saaj.SaajSoapMessage;
import org.w3c.dom.Document;
import org.w3c.dom.Element;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import java.io.ByteArrayInputStream;
import java.nio.charset.StandardCharsets;

/**
 * Mock SOAP Endpoint with MTOM Attachment Support
 */
@Slf4j
@Endpoint
public class MockSoapEndpoint {

    private static final String NAMESPACE_URI = "urn:swift:saa:xsd:soapha";
    private final MockResponseService mockResponseService;

    public MockSoapEndpoint(MockResponseService mockResponseService) {
        this.mockResponseService = mockResponseService;
    }

    /**
     * Handles GetAck requests and returns response with binary attachment
     */
    @PayloadRoot(namespace = NAMESPACE_URI, localPart = "GetAck")
    @ResponsePayload
    public Element handleGetAckRequest(
            @RequestPayload Element request,
            MessageContext messageContext) throws Exception {

        log.info("Processing GetAck request");

        // Get mock response data
        var mockResponse = mockResponseService.getMockResponse();

        // Add attachment to SOAP message
        SaajSoapMessage soapResponse = (SaajSoapMessage) messageContext.getResponse();
        
        // Create attachment
        DataHandler dataHandler = new DataHandler(
                mockResponse.getAttachmentContent(),
                "application/xml"
        );
        
        AttachmentPart attachment = soapResponse.getSaajMessage().createAttachmentPart(dataHandler);
        attachment.setContentId("<" + mockResponse.getAttachmentContentId() + ">");
        attachment.setContentType("application/xml");
        
        soapResponse.getSaajMessage().addAttachmentPart(attachment);

        log.info("Added binary attachment with Content-ID: {}", mockResponse.getAttachmentContentId());

        // Return SOAP body
        return parseXmlStringToElement(mockResponse.getSoapBodyContent());
    }

    /**
     * Parse XML string to DOM Element
     */
    private Element parseXmlStringToElement(String xml) throws Exception {
        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
        factory.setNamespaceAware(true);
        DocumentBuilder builder = factory.newDocumentBuilder();
        Document doc = builder.parse(
                new ByteArrayInputStream(xml.getBytes(StandardCharsets.UTF_8))
        );
        return doc.getDocumentElement();
    }
}
```

### **6. MockResponseService.java**

```java
package com.example.soapmock.service;

import com.example.soapmock.model.MockResponse;
import jakarta.annotation.PostConstruct;
import lombok.extern.slf4j.Slf4j;
import org.springframework.core.io.ClassPathResource;
import org.springframework.stereotype.Service;
import org.springframework.util.StreamUtils;

import java.io.IOException;
import java.nio.charset.StandardCharsets;

/**
 * Service to parse and provide mock MTOM response
 */
@Slf4j
@Service
public class MockResponseService {

    private MockResponse mockResponse;

    @PostConstruct
    public void init() throws IOException {
        log.info("Loading mock response from classpath...");
        
        ClassPathResource resource = new ClassPathResource("mock/response.txt");
        String content = StreamUtils.copyToString(
                resource.getInputStream(),
                StandardCharsets.UTF_8
        );

        this.mockResponse = parseMtomResponse(content);
        log.info("Mock response loaded successfully");
    }

    public MockResponse getMockResponse() {
        return mockResponse;
    }

    /**
     * Parse MTOM multipart response
     */
    private MockResponse parseMtomResponse(String content) {
        String[] parts = content.split("--uuid:cdd815dd-2ca2-40f5-ba23-5f5b0f1d9ff7");

        String soapBody = null;
        String attachmentContent = null;
        String attachmentContentId = "39379f5a-a83b-4226-851e-fe9e5f9aa9f3";

        for (String part : parts) {
            if (part.trim().isEmpty() || part.trim().equals("--")) {
                continue;
            }

            // Find SOAP Body
            if (part.contains("<SOAP-ENV:Body>")) {
                int bodyStart = part.indexOf("<GetAckResponse");
                int bodyEnd = part.indexOf("</GetAckResponse>") + "</GetAckResponse>".length();
                if (bodyStart != -1 && bodyEnd != -1) {
                    soapBody = part.substring(bodyStart, bodyEnd);
                }
            }

            // Find attachment content
            if (part.contains("Content-Type: application/octet-stream")) {
                int contentStart = part.indexOf("<AppHdr");
                if (contentStart != -1) {
                    attachmentContent = part.substring(contentStart).trim();
                    // Remove trailing boundary if exists
                    if (attachmentContent.endsWith("--")) {
                        attachmentContent = attachmentContent.substring(0, attachmentContent.lastIndexOf("--")).trim();
                    }
                }
            }
        }

        log.debug("Parsed SOAP Body length: {}", soapBody != null ? soapBody.length() : 0);
        log.debug("Parsed Attachment length: {}", attachmentContent != null ? attachmentContent.length() : 0);

        return new MockResponse(soapBody, attachmentContent, attachmentContentId);
    }
}
```

### **7. MockResponse.java**

```java
package com.example.soapmock.model;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * Model class for mock SOAP response with attachment
 */
@Data
@AllArgsConstructor
@NoArgsConstructor
public class MockResponse {
    
    /**
     * SOAP Body content (GetAckResponse)
     */
    private String soapBodyContent;
    
    /**
     * Binary attachment content (camt.053 document)
     */
    private String attachmentContent;
    
    /**
     * Content-ID for the attachment
     */
    private String attachmentContentId;
}
```

### **8. application.yml**

```yaml
server:
  port: 8080
  servlet:
    context-path: /

spring:
  application:
    name: soap-mock-server-mtom
  
  # MTOM Configuration
  ws:
    mtom:
      enabled: true

logging:
  level:
    root: INFO
    com.example.soapmock: DEBUG
    org.springframework.ws: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

# Actuator
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: always

info:
  app:
    name: SOAP Mock Server with MTOM
    description: Returns SOAP responses with binary attachments
    version: 1.0.0
```

### **9. Proje Yapƒ±sƒ±**

```
soap-mock-server-mtom/
‚îú‚îÄ‚îÄ pom.xml
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ src/
    ‚îú‚îÄ‚îÄ main/
    ‚îÇ   ‚îú‚îÄ‚îÄ java/
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ com/
    ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ example/
    ‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ soapmock/
    ‚îÇ   ‚îÇ               ‚îú‚îÄ‚îÄ SoapMockServerApplication.java
    ‚îÇ   ‚îÇ               ‚îú‚îÄ‚îÄ config/
    ‚îÇ   ‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ WebServiceConfig.java
    ‚îÇ   ‚îÇ               ‚îÇ   ‚îî‚îÄ‚îÄ SoapLoggingInterceptor.java
    ‚îÇ   ‚îÇ               ‚îú‚îÄ‚îÄ endpoint/
    ‚îÇ   ‚îÇ               ‚îÇ   ‚îî‚îÄ‚îÄ MockSoapEndpoint.java
    ‚îÇ   ‚îÇ               ‚îú‚îÄ‚îÄ service/
    ‚îÇ   ‚îÇ               ‚îÇ   ‚îî‚îÄ‚îÄ MockResponseService.java
    ‚îÇ   ‚îÇ               ‚îî‚îÄ‚îÄ model/
    ‚îÇ   ‚îÇ                   ‚îî‚îÄ‚îÄ MockResponse.java
    ‚îÇ   ‚îî‚îÄ‚îÄ resources/
    ‚îÇ       ‚îú‚îÄ‚îÄ application.yml
    ‚îÇ       ‚îú‚îÄ‚îÄ wsdl/
    ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ soapha.wsdl
    ‚îÇ       ‚îî‚îÄ‚îÄ mock/
    ‚îÇ           ‚îî‚îÄ‚îÄ response.txt  (Untitled-1.txt dosyanƒ±zƒ± buraya koyun)
    ‚îî‚îÄ‚îÄ test/
        ‚îî‚îÄ‚îÄ java/
            ‚îî‚îÄ‚îÄ com/
                ‚îî‚îÄ‚îÄ example/
                    ‚îî‚îÄ‚îÄ soapmock/
                        ‚îî‚îÄ‚îÄ SoapMockServerApplicationTests.java
```

### **10. README.md**

```markdown
# SOAP Mock Server with MTOM Support

Professional SOAP mock server supporting **MTOM (Message Transmission Optimization Mechanism)** for binary attachments.

## üöÄ Features

- ‚úÖ **MTOM Support** - Binary attachment handling
- ‚úÖ **SOAP 1.1 Protocol**
- ‚úÖ **Spring Boot 3.x + Java 17**
- ‚úÖ **Clean Architecture**
- ‚úÖ **Comprehensive Logging**
- ‚úÖ **Health Monitoring**

## üìã Prerequisites

- Java 17+
- Maven 3.8+

## üõ†Ô∏è Setup

1. **Place files:**
   - Copy your WSDL to: `src/main/resources/wsdl/soapha.wsdl`
   - Copy Untitled-1.txt to: `src/main/resources/mock/response.txt`

2. **Build:**
```bash
mvn clean install
```

3. **Run:**
```bash
mvn spring-boot:run
```

## üì° Endpoints

- **SOAP Endpoint**: `http://localhost:8080/ws`
- **WSDL**: `http://localhost:8080/ws/soapha.wsdl`
- **Health**: `http://localhost:8080/actuator/health`

## üß™ Testing with SoapUI

1. Create SOAP project
2. Import WSDL: `http://localhost:8080/ws/soapha.wsdl`
3. Send request - server returns MTOM response with attachment

## üß™ Testing with cURL

```bash
curl -X POST http://localhost:8080/ws \
  -H "Content-Type: text/xml; charset=utf-8" \
  -H "SOAPAction: GetAck" \
  -d '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:saa="urn:swift:saa:xsd:soapha">
   <soapenv:Header/>
   <soapenv:Body>
      <saa:GetAck>
         <saa:SessionToken>test-token</saa:SessionToken>
      </saa:GetAck>
   </soapenv:Body>
</soapenv:Envelope>'
```

## üìä Response Format

Server returns multipart SOAP response:
- **Part 1**: SOAP Envelope with GetAckResponse
- **Part 2**: Binary attachment (camt.053 document) referenced by `cid:39379f5a-a83b-4226-851e-fe9e5f9aa9f3`

## üèóÔ∏è Architecture

- **Clean Code**: SOLID principles
- **Separation of Concerns**: Config, Service, Endpoint layers
- **Logging**: SLF4J with detailed tracing
- **Error Handling**: Graceful fault management
- **Production Ready**: Actuator health checks

## üìù License

MIT
```

### **11. Test Class**

```java
package com.example.soapmock;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class SoapMockServerApplicationTests {

    @Test
    void contextLoads() {
        // Context loads successfully with MTOM enabled
    }
}
```

## üéØ Kullanƒ±m Talimatlarƒ±

1. **Dosyalarƒ± yerle≈ütirin:**
   - `wsdl.txt` ‚Üí `src/main/resources/wsdl/soapha.wsdl`
   - `Untitled-1.txt` ‚Üí `src/main/resources/mock/response.txt`

2. **Projeyi √ßalƒ±≈ütƒ±rƒ±n:**
```bash
mvn clean install
mvn spring-boot:run
```

3. **Test edin:**
```bash
curl http://localhost:8080/ws/soapha.wsdl
```

Bu yapƒ± ile **MTOM binary attachment** destekli profesyonel bir SOAP mock server'ƒ±nƒ±z hazƒ±r! üéâ
