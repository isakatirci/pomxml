`AttachmentMarshaller` null olması, Spring WS'nin JAXB marshaller'ı doğru yapılandırmadığı anlamına geliyor. Bu sorunu çözmek için birkaç yol var:

## Çözüm 1: Custom Marshaller ile AttachmentMarshaller'ı Set Etme

```java
package com.ykb.cosmos.commonservices.saaadapter.config;

import com.ykb.cosmos.commonservices.saaadapter.interceptor.AttachmentInterceptor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.web.servlet.ServletRegistrationBean;
import org.springframework.context.ApplicationContext;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Profile;
import org.springframework.core.io.ClassPathResource;
import org.springframework.oxm.jaxb.Jaxb2Marshaller;
import org.springframework.ws.config.annotation.EnableWs;
import org.springframework.ws.config.annotation.WsConfigurerAdapter;
import org.springframework.ws.server.EndpointInterceptor;
import org.springframework.ws.server.endpoint.adapter.DefaultMethodEndpointAdapter;
import org.springframework.ws.server.endpoint.adapter.method.MarshallingPayloadMethodProcessor;
import org.springframework.ws.server.endpoint.adapter.method.MethodArgumentResolver;
import org.springframework.ws.server.endpoint.adapter.method.MethodReturnValueHandler;
import org.springframework.ws.soap.saaj.SaajSoapMessageFactory;
import org.springframework.ws.soap.server.endpoint.adapter.SoapMethodEndpointAdapter;
import org.springframework.ws.transport.http.MessageDispatcherServlet;
import org.springframework.ws.wsdl.wsdl11.DefaultWsdl11Definition;
import org.springframework.xml.xsd.SimpleXsdSchema;
import org.springframework.xml.xsd.XsdSchema;

import jakarta.xml.soap.MessageFactory;
import jakarta.xml.soap.SOAPConstants;
import java.util.ArrayList;
import java.util.List;

@EnableWs
@Configuration
@Profile("mock")
public class MockWebServiceConfig extends WsConfigurerAdapter {

    @Autowired
    private AttachmentInterceptor attachmentInterceptor;

    @Override
    public void addInterceptors(List<EndpointInterceptor> interceptors) {
        interceptors.add(attachmentInterceptor);
    }

    @Bean
    public ServletRegistrationBean<MessageDispatcherServlet> messageDispatcherServlet(
            ApplicationContext applicationContext) {
        MessageDispatcherServlet servlet = new MessageDispatcherServlet();
        servlet.setApplicationContext(applicationContext);
        servlet.setTransformWsdlLocations(true);
        
        ServletRegistrationBean<MessageDispatcherServlet> registration = 
            new ServletRegistrationBean<>(servlet, "/mock-ws", "/mock-ws/*");
        registration.setLoadOnStartup(1);
        
        return registration;
    }

    @Bean
    public SaajSoapMessageFactory messageFactory() {
        SaajSoapMessageFactory messageFactory = new SaajSoapMessageFactory();
        
        try {
            MessageFactory saajMessageFactory = MessageFactory.newInstance(SOAPConstants.SOAP_1_1_PROTOCOL);
            messageFactory.setMessageFactory(saajMessageFactory);
        } catch (Exception e) {
            throw new RuntimeException("Failed to create SAAJ MessageFactory", e);
        }
        
        return messageFactory;
    }

    @Bean
    public Jaxb2Marshaller marshaller() {
        Jaxb2Marshaller marshaller = new Jaxb2Marshaller();
        marshaller.setPackagesToScan("com.ykb.cosmos.commonservices.saaadapter.external.model");
        marshaller.setMtomEnabled(true);
        return marshaller;
    }

    @Bean
    public SoapMethodEndpointAdapter soapMethodEndpointAdapter() {
        SoapMethodEndpointAdapter adapter = new SoapMethodEndpointAdapter();
        
        List<MethodArgumentResolver> argumentResolvers = new ArrayList<>();
        argumentResolvers.add(new MarshallingPayloadMethodProcessor(marshaller()));
        adapter.setCustomMethodArgumentResolvers(argumentResolvers);
        
        List<MethodReturnValueHandler> returnValueHandlers = new ArrayList<>();
        returnValueHandlers.add(new MarshallingPayloadMethodProcessor(marshaller()));
        adapter.setCustomMethodReturnValueHandlers(returnValueHandlers);
        
        return adapter;
    }

    @Bean(name = "swiftService")
    public DefaultWsdl11Definition defaultWsdl11Definition(XsdSchema swiftSchema) {
        DefaultWsdl11Definition wsdl11Definition = new DefaultWsdl11Definition();
        wsdl11Definition.setPortTypeName("SwiftPort");
        wsdl11Definition.setLocationUri("/mock-ws");
        wsdl11Definition.setTargetNamespace("urn:swift:saa:xsd:soapha");
        wsdl11Definition.setSchema(swiftSchema);
        return wsdl11Definition;
    }

    @Bean
    public XsdSchema swiftSchema() {
        return new SimpleXsdSchema(new ClassPathResource("swift-schema.xsd"));
    }
}
```

## Çözüm 2: GetAckResponse'u Basitleştirme (En Kolay Çözüm)

`attachment` field'ını String olarak tanımlayın, DataHandler yerine:

```java
package com.ykb.cosmos.commonservices.saaadapter.external.model;

import jakarta.xml.bind.annotation.*;
import org.w3c.dom.Element;

@XmlAccessorType(XmlAccessType.FIELD)
@XmlType(name = "", propOrder = {
        "any",
        "attachment"
})
@XmlRootElement(name = "GetAckResponse", namespace = "urn:swift:saa:xsd:soapha")
public class GetAckResponse {

    @XmlAnyElement
    protected Element any;
    
    @XmlElement(namespace = "urn:swift:saa:xsd:soapha")
    protected String attachment;  // String olarak değiştirdik

    public Element getAny() {
        return any;
    }

    public void setAny(Element value) {
        this.any = value;
    }

    public String getAttachment() {
        return attachment;
    }

    public void setAttachment(String value) {
        this.attachment = value;
    }
}
```

Ve endpoint'te:

```java
@PayloadRoot(namespace = NAMESPACE_URI, localPart = "GetAckRequest")
@ResponsePayload
public GetAckResponse getAck(@RequestPayload Element request, MessageContext messageContext) {
    
    log.info("Mock SOAP Server: GetAck request received");
    
    try {
        // Add SOAP Header to Response
        addSoapHeader(messageContext);
        
        // Add attachment to SOAP message first
        addAttachmentToSoapMessage(messageContext);
        
        // Create Response
        GetAckResponse response = new GetAckResponse();
        
        // Create DataPDU Element (any element)
        Element dataPduElement = createDataPDUElement();
        response.setAny(dataPduElement);
        
        // Set CID reference as String
        response.setAttachment("cid:" + ATTACHMENT_CID);
        
        log.info("Mock SOAP Server: Response created successfully");
        return response;
        
    } catch (Exception e) {
        log.error("Error creating mock response", e);
        throw new RuntimeException("Failed to create mock response", e);
    }
}
```

## Çözüm 3: Manuel XML Response Oluşturma (En Garantili)

JAXB yerine manuel olarak SOAP response oluşturun:

```java
package com.ykb.cosmos.commonservices.saaadapter.endpoint;

import jakarta.activation.DataHandler;
import jakarta.xml.soap.*;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ws.context.MessageContext;
import org.springframework.ws.server.endpoint.annotation.Endpoint;
import org.springframework.ws.server.endpoint.annotation.PayloadRoot;
import org.springframework.ws.server.endpoint.annotation.RequestPayload;
import org.springframework.ws.soap.saaj.SaajSoapMessage;
import org.w3c.dom.Element;

import javax.xml.namespace.QName;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import java.nio.charset.StandardCharsets;

@Slf4j
@Endpoint
public class MockSwiftSoapEndpoint {

    private static final String NAMESPACE_URI = "urn:swift:saa:xsd:soapha";
    private static final String HEADER_NAMESPACE = "urn:swift:saa:xsd:soapha";
    private static final String SAA_NAMESPACE = "urn:swift:saa:xsd:saa.2.0";
    private static final String ATTACHMENT_CID = "39379f5a-a83b-4226-851e-fe9e5f9aa9f3";

    @PayloadRoot(namespace = NAMESPACE_URI, localPart = "GetAckRequest")
    public void getAck(@RequestPayload Element request, MessageContext messageContext) {
        
        log.info("Mock SOAP Server: GetAck request received");
        
        try {
            SaajSoapMessage soapResponse = (SaajSoapMessage) messageContext.getResponse();
            SOAPMessage saajMessage = soapResponse.getSaajMessage();
            
            // Add SOAP Header
            addSoapHeader(saajMessage);
            
            // Add SOAP Body
            addSoapBody(saajMessage);
            
            // Add Attachment
            addAttachment(saajMessage);
            
            log.info("Mock SOAP Server: Response created successfully");
            
        } catch (Exception e) {
            log.error("Error creating mock response", e);
            throw new RuntimeException("Failed to create mock response", e);
        }
    }

    private void addSoapHeader(SOAPMessage saajMessage) throws SOAPException {
        SOAPHeader soapHeader = saajMessage.getSOAPHeader();
        
        if (soapHeader == null) {
            soapHeader = saajMessage.getSOAPPart().getEnvelope().addHeader();
        }
        
        QName headerQName = new QName(HEADER_NAMESPACE, "SAAHeader", "ns2");
        SOAPHeaderElement headerElement = soapHeader.addHeaderElement(headerQName);
        headerElement.setAttribute("Id", "SAAHeader");
        
        headerElement.addChildElement(new QName(HEADER_NAMESPACE, "SessionToken", "ns2"))
                .setTextContent("da1351f1-654b-45f5-aebc-c12218cf");
        headerElement.addChildElement(new QName(HEADER_NAMESPACE, "SequenceNumber", "ns2"))
                .setTextContent("93825");
        
        log.debug("SOAP Header added successfully");
    }

    private void addSoapBody(SOAPMessage saajMessage) throws Exception {
        SOAPBody soapBody = saajMessage.getSOAPBody();
        
        // Create GetAckResponse element
        SOAPElement getAckResponse = soapBody.addChildElement("GetAckResponse", "ns1", NAMESPACE_URI);
        
        // Add DataPDU
        Element dataPDU = createDataPDUElement();
        getAckResponse.appendChild(saajMessage.getSOAPPart().importNode(dataPDU, true));
        
        // Add attachment CID reference
        SOAPElement attachmentElement = getAckResponse.addChildElement("attachment", "ns1", NAMESPACE_URI);
        attachmentElement.setTextContent("cid:" + ATTACHMENT_CID);
        
        log.debug("SOAP Body added successfully");
    }

    private void addAttachment(SOAPMessage saajMessage) throws Exception {
        String attachmentContent = """
                <?xml version="1.0" encoding="UTF-8"?>
                <AppHdr xmlns="urn:iso:std:iso:20022:tech:xsd:head.001.001.01">
                    <Fr>
                        <FIId>
                            <FinInstnId>
                                <BICFI>TRGTXEPMRTG</BICFI>
                            </FinInstnId>
                        </FIId>
                    </Fr>
                    <To>
                        <FIId>
                            <FinInstnId>
                                <BICFI>KABANL2AXXX</BICFI>
                            </FinInstnId>
                        </FIId>
                    </To>
                    <BizMsgIdr>864993564</BizMsgIdr>
                    <MsgDefIdr>camt.053.001.08</MsgDefIdr>
                    <CreDt>2025-11-24T19:53:06.338Z</CreDt>
                </AppHdr>
                <Document xmlns="urn:iso:std:iso:20022:tech:xsd:camt.053.001.08">
                    <BkToCstmrStmt>
                        <GrpHdr>
                            <MsgId>NONREF</MsgId>
                            <CreDtTm>2025-11-24T19:53:06.241+00:00</CreDtTm>
                        </GrpHdr>
                    </BkToCstmrStmt>
                </Document>
                """;
        
        byte[] attachmentBytes = attachmentContent.getBytes(StandardCharsets.UTF_8);
        
        ByteArrayDataSource dataSource = new ByteArrayDataSource(attachmentBytes, "application/octet-stream");
        DataHandler dataHandler = new DataHandler(dataSource);
        
        AttachmentPart attachmentPart = saajMessage.createAttachmentPart(dataHandler);
        attachmentPart.setContentId("<" + ATTACHMENT_CID + ">");
        attachmentPart.setContentType("application/octet-stream");
        saajMessage.addAttachmentPart(attachmentPart);
        
        log.debug("Attachment added successfully with CID: {}", ATTACHMENT_CID);
    }

    private Element createDataPDUElement() throws Exception {
        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
        factory.setNamespaceAware(true);
        DocumentBuilder builder = factory.newDocumentBuilder();
        org.w3c.dom.Document document = builder.newDocument();
        
        // Create DataPDU root element
        Element dataPDU = document.createElementNS(SAA_NAMESPACE, "Saa:DataPDU");
        dataPDU.setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns:Saa", SAA_NAMESPACE);
        
        // Revision
        Element revision = document.createElementNS(SAA_NAMESPACE, "Saa:Revision");
        revision.setTextContent("2.0.7");
        dataPDU.appendChild(revision);
        
        // Header
        Element header = document.createElementNS(SAA_NAMESPACE, "Saa:Header");
        
        // Message
        Element message = document.createElementNS(SAA_NAMESPACE, "Saa:Message");
        
        // SenderReference
        Element senderReference = document.createElementNS(SAA_NAMESPACE, "Saa:SenderReference");
        senderReference.setTextContent("OTRGTXEPMXXX053$2511242151610");
        message.appendChild(senderReference);
        
        // MessageIdentifier
        Element messageIdentifier = document.createElementNS(SAA_NAMESPACE, "Saa:MessageIdentifier");
        messageIdentifier.setTextContent("camt.053.001.08");
        message.appendChild(messageIdentifier);
        
        // FileLogicalName
        Element fileLogicalName = document.createElementNS(SAA_NAMESPACE, "Saa:FileLogicalName");
        fileLogicalName.setTextContent("snp02145D11764014008677451");
        message.appendChild(fileLogicalName);
        
        header.appendChild(message);
        dataPDU.appendChild(header);
        
        log.debug("DataPDU Element created successfully");
        return dataPDU;
    }
}
```

## Önerilen Çözüm

**Çözüm 2**'yi (String kullanma) öneriyorum çünkü:
1. En basit ve anlaşılır
2. JAXB marshalling sorunlarını bypass eder
3. İstediğiniz XML formatını üretir

```xml
<GetAckResponse>
    <Saa:DataPDU>...</Saa:DataPDU>
    <attachment>cid:39379f5a-a83b-4226-851e-fe9e5f9aa9f3</attachment>
</GetAckResponse>
```

Ve attachment gerçek içeriği SOAP message attachment'ında olur. Hangisini tercih edersiniz?
